<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•IndexedDBæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç®€å•IndexedDBæµ‹è¯•</h1>
    
    <div class="test-item">
        <h3>æµ‹è¯•æ§åˆ¶</h3>
        <button onclick="testModuleLoading()">æµ‹è¯•æ¨¡å—åŠ è½½</button>
        <button onclick="testDataOperations()">æµ‹è¯•æ•°æ®æ“ä½œ</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-item">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="results"></div>
    </div>

    <div class="test-item">
        <h3>è¯¦ç»†æ—¥å¿—</h3>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            const logElement = document.getElementById('log');
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function addResult(testName, success, message) {
            const resultsElement = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-item ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                <br><small>${message}</small>
            `;
            resultsElement.appendChild(resultDiv);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
        }

        async function testModuleLoading() {
            log('å¼€å§‹æµ‹è¯•æ¨¡å—åŠ è½½...');
            
            // æ£€æŸ¥IndexedDBæ”¯æŒ
            if (!window.indexedDB) {
                addResult('IndexedDBæ”¯æŒ', false, 'æµè§ˆå™¨ä¸æ”¯æŒIndexedDB');
                log('æµè§ˆå™¨ä¸æ”¯æŒIndexedDB', 'error');
                return;
            }
            addResult('IndexedDBæ”¯æŒ', true, 'æµè§ˆå™¨æ”¯æŒIndexedDB');
            log('æµè§ˆå™¨æ”¯æŒIndexedDB', 'success');

            // åŠ¨æ€åŠ è½½æ¨¡å—
            try {
                const script = document.createElement('script');
                script.src = 'indexeddb-storage.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                log('è„šæœ¬åŠ è½½å®Œæˆ', 'success');
                
                // ç­‰å¾…æ¨¡å—åˆå§‹åŒ–
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (window.indexedDBStorage) {
                    addResult('æ¨¡å—åŠ è½½', true, 'IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½æˆåŠŸ');
                    log('IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½æˆåŠŸ', 'success');
                    
                    // æµ‹è¯•åˆå§‹åŒ–
                    try {
                        await window.indexedDBStorage.init();
                        addResult('æ¨¡å—åˆå§‹åŒ–', true, 'æ¨¡å—åˆå§‹åŒ–æˆåŠŸ');
                        log('æ¨¡å—åˆå§‹åŒ–æˆåŠŸ', 'success');
                    } catch (error) {
                        addResult('æ¨¡å—åˆå§‹åŒ–', false, `åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                        log(`æ¨¡å—åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    }
                } else {
                    addResult('æ¨¡å—åŠ è½½', false, 'æ¨¡å—æœªæ­£ç¡®åˆå§‹åŒ–');
                    log('æ¨¡å—æœªæ­£ç¡®åˆå§‹åŒ–', 'error');
                }
            } catch (error) {
                addResult('æ¨¡å—åŠ è½½', false, `åŠ è½½å¤±è´¥: ${error.message}`);
                log(`æ¨¡å—åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDataOperations() {
            log('å¼€å§‹æµ‹è¯•æ•°æ®æ“ä½œ...');
            
            if (!window.indexedDBStorage) {
                addResult('æ•°æ®æ“ä½œ', false, 'IndexedDBæ¨¡å—æœªåŠ è½½');
                log('IndexedDBæ¨¡å—æœªåŠ è½½', 'error');
                return;
            }

            try {
                // æµ‹è¯•ä¿å­˜æ•°æ®
                const testData = {
                    currentNoteId: 'test_note',
                    notes: {
                        'test_note': {
                            title: 'æµ‹è¯•ç¬”è®°',
                            content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç¬”è®°',
                            versions: [],
                            lastModified: new Date().toISOString()
                        }
                    }
                };

                await window.indexedDBStorage.saveData(testData);
                addResult('æ•°æ®ä¿å­˜', true, 'æ•°æ®ä¿å­˜æˆåŠŸ');
                log('æ•°æ®ä¿å­˜æˆåŠŸ', 'success');

                // æµ‹è¯•åŠ è½½æ•°æ®
                const loadedData = await window.indexedDBStorage.loadData();
                if (loadedData && loadedData.notes && loadedData.notes.test_note) {
                    addResult('æ•°æ®åŠ è½½', true, 'æ•°æ®åŠ è½½æˆåŠŸ');
                    log('æ•°æ®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    addResult('æ•°æ®åŠ è½½', false, 'æ•°æ®åŠ è½½å¤±è´¥æˆ–æ•°æ®ä¸å®Œæ•´');
                    log('æ•°æ®åŠ è½½å¤±è´¥æˆ–æ•°æ®ä¸å®Œæ•´', 'error');
                }

            } catch (error) {
                addResult('æ•°æ®æ“ä½œ', false, `æ“ä½œå¤±è´¥: ${error.message}`);
                log(`æ•°æ®æ“ä½œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...');
            setTimeout(() => {
                testModuleLoading();
            }, 500);
        });
    </script>
</body>
</html>
