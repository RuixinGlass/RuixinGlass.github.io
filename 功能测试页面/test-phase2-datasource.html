<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¶æ®µäºŒï¼šæ•°æ®æºç»Ÿä¸€æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.success:hover {
            background: #218838;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ é˜¶æ®µäºŒï¼šæ•°æ®æºç»Ÿä¸€æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•é˜¶æ®µäºŒçš„æ•°æ®æºç»Ÿä¸€ä¿®å¤ï¼š</p>
        <ul>
            <li><strong>ç§»é™¤localStorageå›é€€</strong>ï¼šå®Œå…¨ä¾èµ–IndexedDB</li>
            <li><strong>å•ä¸€æ•°æ®æº</strong>ï¼šé¿å…æ•°æ®æºæ··ä¹±</li>
            <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šæ˜ç¡®çš„é”™è¯¯æç¤ºå’Œå¤„ç†</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <div id="testSteps">
            <div class="status info">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <button class="test-button" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
        <button class="test-button danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="test-button success" onclick="loadMainApp()">åŠ è½½ä¸»åº”ç”¨</button>
        <button class="test-button" onclick="testDataConsistency()">æµ‹è¯•æ•°æ®ä¸€è‡´æ€§</button>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="logArea" class="log-area"></div>
    </div>

    <script>
        let testStep = 0;
        const testSteps = [
            "1. åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—",
            "2. æµ‹è¯•loadFromLocalStorage()å‡½æ•°ï¼ˆæ— localStorageå›é€€ï¼‰",
            "3. æµ‹è¯•saveToLocalStorage()å‡½æ•°ï¼ˆæ— localStorageå›é€€ï¼‰",
            "4. æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥å¤„ç†",
            "5. æµ‹è¯•æ•°æ®ä¿å­˜å¤±è´¥å¤„ç†",
            "6. éªŒè¯å•ä¸€æ•°æ®æºç­–ç•¥",
            "7. æµ‹è¯•æ•°æ®ä¸€è‡´æ€§"
        ];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStepStatus(step, status, message) {
            const testStepsDiv = document.getElementById('testSteps');
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : status === 'warning' ? 'warning' : 'info';
            testStepsDiv.innerHTML += `<div class="status ${statusClass}">${testSteps[step]}: ${message}</div>`;
        }

        function clearLog() {
            document.getElementById('logArea').textContent = '';
            document.getElementById('testSteps').innerHTML = '<div class="status info">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>';
            testStep = 0;
        }

        async function startTest() {
            clearLog();
            log('å¼€å§‹é˜¶æ®µäºŒï¼šæ•°æ®æºç»Ÿä¸€æµ‹è¯•...');
            
            try {
                // æ­¥éª¤1: åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—
                log('æ­¥éª¤1: åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—');
                await loadIndexedDBModule();
                updateStepStatus(0, 'success', 'æ¨¡å—åŠ è½½æˆåŠŸ');
                
                // æ­¥éª¤2: æµ‹è¯•loadFromLocalStorage()å‡½æ•°
                log('æ­¥éª¤2: æµ‹è¯•loadFromLocalStorage()å‡½æ•°ï¼ˆæ— localStorageå›é€€ï¼‰');
                await testLoadFromLocalStorage();
                updateStepStatus(1, 'success', 'æ•°æ®åŠ è½½å‡½æ•°æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤3: æµ‹è¯•saveToLocalStorage()å‡½æ•°
                log('æ­¥éª¤3: æµ‹è¯•saveToLocalStorage()å‡½æ•°ï¼ˆæ— localStorageå›é€€ï¼‰');
                await testSaveToLocalStorage();
                updateStepStatus(2, 'success', 'æ•°æ®ä¿å­˜å‡½æ•°æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤4: æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥å¤„ç†
                log('æ­¥éª¤4: æµ‹è¯•æ•°æ®åŠ è½½å¤±è´¥å¤„ç†');
                await testLoadFailureHandling();
                updateStepStatus(3, 'success', 'åŠ è½½å¤±è´¥å¤„ç†æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤5: æµ‹è¯•æ•°æ®ä¿å­˜å¤±è´¥å¤„ç†
                log('æ­¥éª¤5: æµ‹è¯•æ•°æ®ä¿å­˜å¤±è´¥å¤„ç†');
                await testSaveFailureHandling();
                updateStepStatus(4, 'success', 'ä¿å­˜å¤±è´¥å¤„ç†æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤6: éªŒè¯å•ä¸€æ•°æ®æºç­–ç•¥
                log('æ­¥éª¤6: éªŒè¯å•ä¸€æ•°æ®æºç­–ç•¥');
                await testSingleDataSource();
                updateStepStatus(5, 'success', 'å•ä¸€æ•°æ®æºç­–ç•¥éªŒè¯é€šè¿‡');
                
                // æ­¥éª¤7: æµ‹è¯•æ•°æ®ä¸€è‡´æ€§
                log('æ­¥éª¤7: æµ‹è¯•æ•°æ®ä¸€è‡´æ€§');
                await testDataConsistency();
                updateStepStatus(6, 'success', 'æ•°æ®ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡');
                
                log('âœ… é˜¶æ®µäºŒï¼šæ•°æ®æºç»Ÿä¸€æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStepStatus(testStep, 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function loadIndexedDBModule() {
            return new Promise((resolve, reject) => {
                // åªåŠ è½½IndexedDBå­˜å‚¨æ¨¡å—
                const indexedDBScript = document.createElement('script');
                indexedDBScript.src = 'indexeddb-storage.js';
                indexedDBScript.onload = () => {
                    log('IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½æˆåŠŸ');
                    resolve();
                };
                indexedDBScript.onerror = () => reject(new Error('IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½å¤±è´¥'));
                document.head.appendChild(indexedDBScript);
            });
        }

        async function testLoadFromLocalStorage() {
            // æ¨¡æ‹ŸnotesDataå¯¹è±¡
            window.notesData = {
                currentNoteId: null,
                notes: {}
            };
            
            // æ¨¡æ‹ŸIndexedDBå­˜å‚¨
            window.indexedDBStorage = {
                loadData: async function() {
                    log('æ¨¡æ‹ŸIndexedDB.loadData()è¢«è°ƒç”¨');
                    return {
                        currentNoteId: 'test-note-1',
                        notes: {
                            'test-note-1': {
                                title: 'æµ‹è¯•ç¬”è®°',
                                content: 'è¿™æ˜¯æµ‹è¯•å†…å®¹',
                                lastModified: new Date().toISOString()
                            }
                        }
                    };
                }
            };
            
            // ç›´æ¥æµ‹è¯•loadFromLocalStorageå‡½æ•°é€»è¾‘
            try {
                // åªä¿¡ä»» IndexedDB
                if (window.indexedDBStorage) {
                    const data = await window.indexedDBStorage.loadData();
                    window.notesData.currentNoteId = data.currentNoteId;
                    window.notesData.notes = data.notes;
                    log('ä» IndexedDB åŠ è½½æ•°æ®æˆåŠŸ');
                } else {
                    // å¦‚æœ IndexedDB æ¨¡å—åŠ è½½å¤±è´¥ï¼Œç»™å‡ºæ˜ç¡®é”™è¯¯
                    throw new Error('æ ¸å¿ƒå­˜å‚¨æ¨¡å— (IndexedDB) åŠ è½½å¤±è´¥ï¼');
                }
            } catch (error) {
                log('æ•°æ®åŠ è½½å¤±è´¥:', error);
                // æ¸…ç©ºæ•°æ®ï¼Œé˜²æ­¢åº”ç”¨åœ¨é”™è¯¯çŠ¶æ€ä¸‹è¿è¡Œ
                window.notesData.currentNoteId = null;
                window.notesData.notes = {};
                throw error;
            }
            
            // éªŒè¯æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½
            if (window.notesData.currentNoteId === 'test-note-1' && 
                window.notesData.notes['test-note-1']) {
                log('âœ… loadFromLocalStorage()å‡½æ•°æµ‹è¯•é€šè¿‡ï¼šæ•°æ®æ­£ç¡®åŠ è½½');
            } else {
                throw new Error('loadFromLocalStorage()å‡½æ•°æµ‹è¯•å¤±è´¥ï¼šæ•°æ®åŠ è½½ä¸æ­£ç¡®');
            }
        }

        async function testSaveToLocalStorage() {
            // æ¨¡æ‹ŸIndexedDBå­˜å‚¨
            window.indexedDBStorage = {
                saveData: async function(data) {
                    log('æ¨¡æ‹ŸIndexedDB.saveData()è¢«è°ƒç”¨');
                    log(`ä¿å­˜æ•°æ®ï¼š${Object.keys(data.notes).length} ä¸ªç¬”è®°`);
                    return Promise.resolve();
                },
                backupData: async function(data) {
                    log('æ¨¡æ‹ŸIndexedDB.backupData()è¢«è°ƒç”¨');
                    return Promise.resolve();
                }
            };
            
            // ç›´æ¥æµ‹è¯•saveToLocalStorageå‡½æ•°é€»è¾‘
            try {
                // åªä¿¡ä»» IndexedDB
                if (window.indexedDBStorage) {
                    await window.indexedDBStorage.saveData(window.notesData);
                    // åŒæ—¶åˆ›å»ºå¤‡ä»½
                    await window.indexedDBStorage.backupData(window.notesData);
                    log('IndexedDB æ•°æ®ä¿å­˜æˆåŠŸï¼Œç¬”è®°æ•°é‡:', Object.keys(window.notesData.notes).length);
                } else {
                    throw new Error('æ ¸å¿ƒå­˜å‚¨æ¨¡å— (IndexedDB) åŠ è½½å¤±è´¥ï¼');
                }
            } catch (error) {
                log('ä¿å­˜æ•°æ®åˆ° IndexedDB å¤±è´¥:', error);
                // å°†é”™è¯¯å‘ä¸ŠæŠ›å‡ºï¼Œè®©è°ƒç”¨è€…å¤„ç†
                throw error;
            }
            
            log('âœ… saveToLocalStorage()å‡½æ•°æµ‹è¯•é€šè¿‡ï¼šæ•°æ®æ­£ç¡®ä¿å­˜');
        }

        async function testLoadFailureHandling() {
            // æ¨¡æ‹ŸIndexedDBåŠ è½½å¤±è´¥
            window.indexedDBStorage = {
                loadData: async function() {
                    log('æ¨¡æ‹ŸIndexedDB.loadData()å¤±è´¥');
                    throw new Error('IndexedDBåŠ è½½å¤±è´¥');
                }
            };
            
            // æµ‹è¯•å¤±è´¥å¤„ç†
            try {
                // ç›´æ¥æµ‹è¯•loadFromLocalStorageå‡½æ•°é€»è¾‘
                if (window.indexedDBStorage) {
                    const data = await window.indexedDBStorage.loadData();
                    window.notesData.currentNoteId = data.currentNoteId;
                    window.notesData.notes = data.notes;
                    log('ä» IndexedDB åŠ è½½æ•°æ®æˆåŠŸ');
                } else {
                    throw new Error('æ ¸å¿ƒå­˜å‚¨æ¨¡å— (IndexedDB) åŠ è½½å¤±è´¥ï¼');
                }
                throw new Error('åº”è¯¥æŠ›å‡ºé”™è¯¯ä½†æ²¡æœ‰æŠ›å‡º');
            } catch (error) {
                if (error.message.includes('IndexedDBåŠ è½½å¤±è´¥')) {
                    log('âœ… åŠ è½½å¤±è´¥å¤„ç†æµ‹è¯•é€šè¿‡ï¼šæ­£ç¡®æŠ›å‡ºé”™è¯¯');
                } else {
                    throw error;
                }
            }
        }

        async function testSaveFailureHandling() {
            // æ¨¡æ‹ŸIndexedDBä¿å­˜å¤±è´¥
            window.indexedDBStorage = {
                saveData: async function(data) {
                    log('æ¨¡æ‹ŸIndexedDB.saveData()å¤±è´¥');
                    throw new Error('IndexedDBä¿å­˜å¤±è´¥');
                }
            };
            
            // æµ‹è¯•å¤±è´¥å¤„ç†
            try {
                // ç›´æ¥æµ‹è¯•saveToLocalStorageå‡½æ•°é€»è¾‘
                if (window.indexedDBStorage) {
                    await window.indexedDBStorage.saveData(window.notesData);
                    // åŒæ—¶åˆ›å»ºå¤‡ä»½
                    await window.indexedDBStorage.backupData(window.notesData);
                    log('IndexedDB æ•°æ®ä¿å­˜æˆåŠŸï¼Œç¬”è®°æ•°é‡:', Object.keys(window.notesData.notes).length);
                } else {
                    throw new Error('æ ¸å¿ƒå­˜å‚¨æ¨¡å— (IndexedDB) åŠ è½½å¤±è´¥ï¼');
                }
                throw new Error('åº”è¯¥æŠ›å‡ºé”™è¯¯ä½†æ²¡æœ‰æŠ›å‡º');
            } catch (error) {
                if (error.message.includes('IndexedDBä¿å­˜å¤±è´¥')) {
                    log('âœ… ä¿å­˜å¤±è´¥å¤„ç†æµ‹è¯•é€šè¿‡ï¼šæ­£ç¡®æŠ›å‡ºé”™è¯¯');
                } else {
                    throw error;
                }
            }
        }

        async function testSingleDataSource() {
            // éªŒè¯æ²¡æœ‰localStorageå›é€€é€»è¾‘
            const originalLocalStorage = window.localStorage;
            let localStorageAccessed = false;
            
            // æ¨¡æ‹ŸlocalStorageè®¿é—®æ£€æµ‹
            window.localStorage = {
                getItem: function() {
                    localStorageAccessed = true;
                    return null;
                },
                setItem: function() {
                    localStorageAccessed = true;
                }
            };
            
            // æ­£å¸¸æµ‹è¯•
            window.indexedDBStorage = {
                loadData: async function() {
                    return { currentNoteId: null, notes: {} };
                },
                saveData: async function(data) {
                    return Promise.resolve();
                },
                backupData: async function(data) {
                    return Promise.resolve();
                }
            };
            
            // ç›´æ¥æµ‹è¯•å‡½æ•°é€»è¾‘
            if (window.indexedDBStorage) {
                const data = await window.indexedDBStorage.loadData();
                window.notesData.currentNoteId = data.currentNoteId;
                window.notesData.notes = data.notes;
            }
            
            if (window.indexedDBStorage) {
                await window.indexedDBStorage.saveData(window.notesData);
                await window.indexedDBStorage.backupData(window.notesData);
            }
            
            // æ¢å¤localStorage
            window.localStorage = originalLocalStorage;
            
            if (!localStorageAccessed) {
                log('âœ… å•ä¸€æ•°æ®æºç­–ç•¥éªŒè¯é€šè¿‡ï¼šæ²¡æœ‰è®¿é—®localStorage');
            } else {
                throw new Error('å•ä¸€æ•°æ®æºç­–ç•¥éªŒè¯å¤±è´¥ï¼šä»ç„¶è®¿é—®äº†localStorage');
            }
        }

        async function testDataConsistency() {
            log('æµ‹è¯•æ•°æ®ä¸€è‡´æ€§...');
            
            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testData = {
                currentNoteId: 'note-1',
                notes: {
                    'note-1': {
                        title: 'ä¸€è‡´æ€§æµ‹è¯•ç¬”è®°',
                        content: 'æµ‹è¯•å†…å®¹',
                        lastModified: new Date().toISOString()
                    }
                }
            };
            
            // æ¨¡æ‹ŸIndexedDBå­˜å‚¨
            let savedData = null;
            window.indexedDBStorage = {
                saveData: async function(data) {
                    savedData = JSON.parse(JSON.stringify(data)); // æ·±æ‹·è´
                    log('æ•°æ®å·²ä¿å­˜åˆ°IndexedDB');
                },
                loadData: async function() {
                    return savedData || { currentNoteId: null, notes: {} };
                },
                backupData: async function(data) {
                    log('å¤‡ä»½æ•°æ®å·²åˆ›å»º');
                }
            };
            
            // è®¾ç½®æµ‹è¯•æ•°æ®
            window.notesData = testData;
            
            // ä¿å­˜æ•°æ®
            if (window.indexedDBStorage) {
                await window.indexedDBStorage.saveData(window.notesData);
                await window.indexedDBStorage.backupData(window.notesData);
            }
            
            // æ¸…ç©ºå†…å­˜æ•°æ®
            window.notesData = { currentNoteId: null, notes: {} };
            
            // é‡æ–°åŠ è½½æ•°æ®
            if (window.indexedDBStorage) {
                const data = await window.indexedDBStorage.loadData();
                window.notesData.currentNoteId = data.currentNoteId;
                window.notesData.notes = data.notes;
            }
            
            // éªŒè¯æ•°æ®ä¸€è‡´æ€§
            if (JSON.stringify(window.notesData) === JSON.stringify(testData)) {
                log('âœ… æ•°æ®ä¸€è‡´æ€§æµ‹è¯•é€šè¿‡ï¼šä¿å­˜å’ŒåŠ è½½çš„æ•°æ®å®Œå…¨ä¸€è‡´');
            } else {
                throw new Error('æ•°æ®ä¸€è‡´æ€§æµ‹è¯•å¤±è´¥ï¼šä¿å­˜å’ŒåŠ è½½çš„æ•°æ®ä¸ä¸€è‡´');
            }
        }

        function loadMainApp() {
            log('åŠ è½½ä¸»åº”ç”¨è¿›è¡Œé›†æˆæµ‹è¯•...');
            const iframe = document.createElement('iframe');
            iframe.src = 'index.html';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '1px solid #ccc';
            
            const container = document.createElement('div');
            container.className = 'test-container';
            container.innerHTML = '<h2>ä¸»åº”ç”¨é›†æˆæµ‹è¯•</h2>';
            container.appendChild(iframe);
            
            document.body.appendChild(container);
            
            iframe.onload = () => {
                log('ä¸»åº”ç”¨åŠ è½½å®Œæˆï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
                log('æµ‹è¯•å»ºè®®ï¼š');
                log('1. åˆ›å»ºæ–°ç¬”è®°');
                log('2. ç¼–è¾‘ç¬”è®°å†…å®¹');
                log('3. åˆ·æ–°é¡µé¢éªŒè¯æ•°æ®');
                log('4. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
                log('5. éªŒè¯æ²¡æœ‰localStorageè®¿é—®');
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('é˜¶æ®µäºŒï¼šæ•°æ®æºç»Ÿä¸€æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
        });
    </script>
</body>
</html>
