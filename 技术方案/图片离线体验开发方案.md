# 图片离线体验开发方案

本方案适用于“严谨的版本控制笔记系统”，目标是实现：
- 用户上传/粘贴的图片本地化，彻底离线可用
- 外链图片可选缓存，用户自主决定是否离线

---

## 1. 用户上传/粘贴图片本地化

### 目标
- 用户通过上传/粘贴图片插入笔记时，图片自动转为本地 Blob URL 或 base64，并嵌入 Markdown。
- 图片数据与笔记内容一起本地存储，离线可用。

### 实现步骤
1. 监听编辑区的图片上传、粘贴、拖拽事件。
2. 将图片文件转为 Blob URL 或 base64（推荐 Blob+IndexedDB 持久化）。
3. 在 Markdown 内容中插入本地图片链接（如 `![](blob:...)` 或 `![](data:image/png;base64,...)`）。
4. 保存笔记时，将图片数据与笔记内容一起存储（推荐 IndexedDB 存储图片二进制，localStorage 存储文本）。
5. 渲染时自动读取本地图片数据，离线状态下也能显示。

### 注意事项
- Blob URL 仅当前会话有效，需用 IndexedDB 持久化。
- base64 体积大，适合小图片。
- 可为每篇笔记维护图片映射表（如 `{imgId: blob/base64}`）。

---

## 2. 外链图片可选缓存

### 目标
- 用户插入的外链图片（如 sm.ms 图床）默认不缓存，用户可手动“缓存此图片”。
- 被缓存的外链图片通过 service worker 动态缓存，离线可用。

### 实现步骤
1. 渲染 Markdown 时识别外链图片，为每个外链图片加“缓存/取消缓存”按钮。
2. 用户点击“缓存”按钮时，fetch 图片并用 Cache API 主动缓存该图片 URL。
3. 用户点击“取消缓存”时，从缓存中删除该图片。
4. service worker fetch 事件对图片请求采用“Cache First”策略。
5. UI 提示：已缓存图片显示“已缓存”状态，未缓存可一键缓存。

### 注意事项
- 只缓存用户主动选择的外链图片，避免占用过多空间。
- 可在笔记详情页显示所有已缓存图片，支持批量管理。

---

## 3. 其它细节与建议
- 图片本地化和外链缓存可共存，互不影响。
- 数据导出/迁移时，需支持导出本地图片数据。
- 存储空间管理：可在设置页显示已用空间，支持清理缓存。
- 安全与隐私：本地图片仅限本地访问，外链图片缓存需尊重版权和隐私。

---

## 4. 技术选型建议
- 本地图片存储：推荐 IndexedDB（大容量，适合二进制数据）。
- 外链图片缓存：用 service worker 的 Cache API。
- UI 交互：为图片加“缓存/取消缓存”按钮，状态实时反馈。

---

## 5. 开发优先级建议
1. 先实现“上传/粘贴图片本地化”功能，保证极致离线体验。
2. 再实现“外链图片可选缓存”功能，提升灵活性和用户自主性。
3. 最后完善图片管理、导出、空间清理等辅助功能。

---

> 每一阶段可单独推进，完成后在本文档中勾选并记录细节。 