# 严谨的版本控制笔记系统 —— 块级双链功能开发计划

---

## 一、需求说明

### 1.1 功能目标
- 支持在笔记内容中引用**另一篇笔记的某一块内容**（如段落、列表项、代码块等），实现“块级链接”。
- 支持通过 `[[笔记名#^块ID]]` 语法跳转到目标笔记的指定块，并高亮显示。
- 块ID可自动生成，也可手动添加，兼容老笔记。
- 保持极简、优雅的UI风格，不影响主界面体验。
- 后续可扩展为“反向链接”统计、块级引用预览等高级功能。

---

## 二、技术方案

### 2.1 块ID设计
- 块ID格式：`^xxxxxx`，可为自动生成的短ID或用户自定义。
- 支持在 Markdown 段落、列表项、代码块等后面加 `^块ID`。
- 渲染时为每个带ID的块插入锚点 `<span id="^块ID"></span>`。

### 2.2 块级链接语法
- 形如：`[[笔记名#^块ID]]`
- 解析为：跳转到“笔记名”对应笔记，并滚动/高亮到 `^块ID` 的块。

### 2.3 兼容性
- 老笔记无块ID时，块级链接无效但不报错。
- 不强制所有块有ID，用户可手动添加，编辑器可辅助生成。

---

## 三、分阶段开发目标与细致任务

### 阶段一：基础块级链接支持（推荐先实现）

#### 任务1：块ID识别与锚点插入
- [ ] 渲染 Markdown 时，识别每个段落/列表项/代码块末尾的 `^块ID`，为其插入 `<span id="^块ID"></span>`。
- [ ] 保证插入锚点不影响原有渲染和样式。

#### 任务2：块级链接语法解析
- [ ] 在渲染时识别 `[[笔记名#^块ID]]` 语法。
- [ ] 渲染为可点击的链接，点击后切换到目标笔记并滚动到对应块。
- [ ] 若目标块不存在，仅切换笔记，不报错。

#### 任务3：块级跳转与高亮
- [ ] 切换笔记后，自动滚动到目标块，并短暂高亮显示（如加背景色2秒后淡出）。
- [ ] 保证移动端和PC端体验一致。

#### 任务4：兼容性与性能测试
- [ ] 确认老笔记、无块ID内容渲染无误。
- [ ] 检查大笔记/多块ID场景下性能。

---

### 阶段二：块ID自动生成与编辑器辅助（可选，后续实现）

#### 任务5：块ID自动生成
- [ ] 编辑/保存时，为每个段落/列表项自动生成唯一块ID（如 `^a1b2c3`），仅当用户未手动添加时。
- [ ] 保证ID稳定（如基于内容hash或顺序）。

#### 任务6：编辑器辅助操作
- [ ] 支持“复制块引用”功能（右键菜单/按钮），自动插入 `[[笔记名#^块ID]]`。
- [ ] 支持在编辑区插入块ID。

---

### 阶段三：反向链接与块级引用预览（高级，可后置）

#### 任务7：反向链接统计
- [ ] 统计所有引用本块的笔记和位置，显示在笔记底部或侧栏。

#### 任务8：块级引用悬停预览
- [ ] 鼠标悬停块级链接时，弹出预览目标块内容。

---

## 四、关键代码设计建议

### 4.1 块ID锚点插入（渲染时处理）
- 在 `renderMarkdown` 函数中，渲染后用正则查找 `^块ID`，插入 `<span id="^块ID"></span>`。
- 示例代码片段：
  ```js
  function insertBlockAnchors(html) {
    return html.replace(/(\^([a-zA-Z0-9_-]{3,}))/g, '<span id="$1"></span>');
  }
  // 在 marked 渲染后调用
  html = insertBlockAnchors(html);
  ```

### 4.2 块级链接解析
- 渲染时用正则识别 `[[笔记名#^块ID]]`，替换为 `<a href="#" class="block-link" data-note="笔记名" data-block="^块ID">...</a>`
- 绑定点击事件，切换笔记并滚动到块。

### 4.3 跳转与高亮
- 切换笔记后，查找 `document.getElementById('^块ID')`，滚动到该元素并加高亮class，2秒后移除。

---

## 五、兼容性与风险控制

- **不影响老数据**：无块ID内容正常显示，块级链接无效但不报错。
- **性能可控**：只在渲染时处理，不做全量实时扫描。
- **UI极简**：所有新功能均为“可见即可用”，不影响主界面。

---

## 六、后续可扩展点

- 支持块级引用统计、引用预览、块ID可视化管理等。
- 支持插件化，便于后续功能扩展。

---

## 七、开发推进建议

- 每个阶段、每个任务都可单独开发和测试，逐步集成，风险最小。
- 建议先在测试分支实现，确认无误后合并主分支。

---

如需每个任务的详细实现步骤、正则表达式、UI设计建议或代码模板，请随时告知！
如需将本开发文档保存为 Markdown 文件，也可直接提出。 