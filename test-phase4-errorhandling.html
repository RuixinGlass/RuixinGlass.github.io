<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¶æ®µå››ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .test-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }
        
        .test-section:last-child {
            border-bottom: none;
        }
        
        .test-section h2 {
            color: #4facfe;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-section h2::before {
            content: "ğŸ”§";
            font-size: 1.2em;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #4facfe;
        }
        
        .test-card h3 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .test-card p {
            margin: 0 0 15px 0;
            color: #666;
            line-height: 1.5;
        }
        
        .test-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #2ed573 0%, #1e90ff 100%);
        }
        
        .test-button.warning {
            background: linear-gradient(135deg, #ffa726 0%, #ff7043 100%);
        }
        
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #ff9800;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .health-report {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .health-report h3 {
            color: #333;
            margin: 0 0 15px 0;
        }
        
        .health-metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .health-metric.good {
            border-left: 4px solid #4caf50;
        }
        
        .health-metric.warning {
            border-left: 4px solid #ff9800;
        }
        
        .health-metric.error {
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ é˜¶æ®µå››ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•</h1>
            <p>éªŒè¯æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ã€æ¢å¤æœºåˆ¶å’Œé”™è¯¯å¤„ç†çš„å®Œå–„æ€§</p>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•è¯´æ˜</h2>
            <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•é˜¶æ®µå››çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶ï¼š</p>
            <ul>
                <li><strong>æ•°æ®å®Œæ•´æ€§æ£€æŸ¥</strong>ï¼šæ£€æµ‹å’Œä¿®å¤æ•°æ®ç»“æ„é—®é¢˜</li>
                <li><strong>æ•°æ®æ¢å¤æœºåˆ¶</strong>ï¼šä»å¤‡ä»½æˆ–å¤‡ç”¨æ•°æ®æºæ¢å¤æ•°æ®</li>
                <li><strong>é”™è¯¯ç›‘æ§</strong>ï¼šç›‘æ§æ•°æ®å¥åº·çŠ¶æ€å’Œæ½œåœ¨é—®é¢˜</li>
                <li><strong>ç´§æ€¥æ¢å¤</strong>ï¼šåœ¨æ•°æ®æŸåæ—¶çš„è‡ªåŠ¨æ¢å¤æµç¨‹</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•æ­¥éª¤</h2>
            <div id="testSteps">
                <div class="status info">å‡†å¤‡å¼€å§‹é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•...</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <button class="test-button" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
            <button class="test-button danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button class="test-button warning" onclick="testDataCorruption()">æµ‹è¯•æ•°æ®æŸå</button>
            <button class="test-button success" onclick="testDataRecovery()">æµ‹è¯•æ•°æ®æ¢å¤</button>
            <button class="test-button" onclick="loadMainApp()">åŠ è½½ä¸»åº”ç”¨</button>
        </div>

        <div class="test-section">
            <h2>æ•°æ®å¥åº·ç›‘æ§</h2>
            <div id="healthReport" class="health-report">
                <h3>æ•°æ®å¥åº·çŠ¶æ€</h3>
                <div id="healthMetrics">
                    <div class="health-metric good">
                        <span>æ•°æ®å®Œæ•´æ€§</span>
                        <span>âœ… æ­£å¸¸</span>
                    </div>
                    <div class="health-metric good">
                        <span>å¤‡ä»½çŠ¶æ€</span>
                        <span>âœ… å¯ç”¨</span>
                    </div>
                    <div class="health-metric good">
                        <span>é”™è¯¯å¤„ç†</span>
                        <span>âœ… æ­£å¸¸</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <div id="logArea" class="log-area"></div>
        </div>
    </div>

    <script>
        let testStep = 0;
        const totalSteps = 8;
        const testSteps = [
            "1. åˆå§‹åŒ–IndexedDBå­˜å‚¨æ¨¡å—",
            "2. åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®",
            "3. æµ‹è¯•æ•°æ®å®Œæ•´æ€§æ£€æŸ¥",
            "4. æµ‹è¯•æ•°æ®æŸåæ£€æµ‹",
            "5. æµ‹è¯•æ•°æ®æ¢å¤æœºåˆ¶",
            "6. æµ‹è¯•ç´§æ€¥æ¢å¤æµç¨‹",
            "7. æµ‹è¯•æ•°æ®å¥åº·ç›‘æ§",
            "8. éªŒè¯é”™è¯¯å¤„ç†å®Œå–„æ€§"
        ];

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStepStatus(step, status, message) {
            const testStepsDiv = document.getElementById('testSteps');
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : status === 'warning' ? 'warning' : 'info';
            testStepsDiv.innerHTML += `<div class="status ${statusClass}">${testSteps[step]}: ${message}</div>`;
        }

        function updateProgress(step) {
            const progress = (step / totalSteps) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            document.getElementById('testSteps').innerHTML = '<div class="status info">å‡†å¤‡å¼€å§‹é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•...</div>';
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateHealthReport(metrics) {
            const healthMetricsDiv = document.getElementById('healthMetrics');
            healthMetricsDiv.innerHTML = '';
            
            Object.entries(metrics).forEach(([key, value]) => {
                const status = value.status || 'good';
                const icon = value.status === 'error' ? 'âŒ' : value.status === 'warning' ? 'âš ï¸' : 'âœ…';
                const text = value.text || value;
                
                healthMetricsDiv.innerHTML += `
                    <div class="health-metric ${status}">
                        <span>${key}</span>
                        <span>${icon} ${text}</span>
                    </div>
                `;
            });
        }

        // æ¨¡æ‹ŸIndexedDBå­˜å‚¨
        let mockIndexedDBStorage = {
            isAvailable: true,
            data: null,
            backups: [],
            
            async loadData() {
                log('æ¨¡æ‹ŸIndexedDB.loadData()è¢«è°ƒç”¨');
                if (!this.isAvailable) {
                    throw new Error('IndexedDBä¸å¯ç”¨');
                }
                return this.data || { currentNoteId: null, notes: {} };
            },
            
            async saveData(data) {
                log('æ¨¡æ‹ŸIndexedDB.saveData()è¢«è°ƒç”¨');
                if (!this.isAvailable) {
                    throw new Error('IndexedDBä¸å¯ç”¨');
                }
                this.data = data;
                log(`æ•°æ®å·²ä¿å­˜åˆ°IndexedDBï¼Œç¬”è®°æ•°é‡: ${Object.keys(data.notes || {}).length}`);
                return true;
            },
            
            async backupData(data) {
                log('æ¨¡æ‹ŸIndexedDB.backupData()è¢«è°ƒç”¨');
                const backup = {
                    id: 'backup_' + Date.now(),
                    data: JSON.parse(JSON.stringify(data)), // æ·±æ‹·è´
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                this.backups.push(backup);
                log(`å¤‡ä»½åˆ›å»ºæˆåŠŸï¼ŒID: ${backup.id}`);
                return true;
            },
            
            async getAllBackups() {
                log('æ¨¡æ‹ŸIndexedDB.getAllBackups()è¢«è°ƒç”¨');
                return this.backups;
            }
        };

        // æ¨¡æ‹Ÿæ•°æ®å®Œæ•´æ€§æ£€æŸ¥å‡½æ•°
        function mockCheckAndRepairData(notesData) {
            log('æ¨¡æ‹Ÿæ•°æ®å®Œæ•´æ€§æ£€æŸ¥...');
            
            let repairReport = {
                totalIssues: 0,
                repairedIssues: 0,
                criticalIssues: 0,
                warnings: 0,
                details: []
            };
            
            // æ£€æŸ¥ç¬”è®°æ•°æ®ç»“æ„
            if (!notesData.notes || typeof notesData.notes !== 'object') {
                notesData.notes = {};
                repairReport.totalIssues++;
                repairReport.repairedIssues++;
                repairReport.criticalIssues++;
                repairReport.details.push('ç¬”è®°æ•°æ®ç»“æ„é‡ç½®');
            }
            
            // æ£€æŸ¥æ¯ä¸ªç¬”è®°çš„å®Œæ•´æ€§
            Object.keys(notesData.notes).forEach(noteId => {
                const note = notesData.notes[noteId];
                
                if (!note || typeof note !== 'object') {
                    delete notesData.notes[noteId];
                    repairReport.totalIssues++;
                    repairReport.repairedIssues++;
                    repairReport.details.push(`åˆ é™¤å¼‚å¸¸ç¬”è®°: ${noteId}`);
                    return;
                }
                
                if (typeof note.content !== 'string') {
                    note.content = '';
                    repairReport.totalIssues++;
                    repairReport.repairedIssues++;
                    repairReport.details.push(`ä¿®å¤ç¬”è®°å†…å®¹: ${noteId}`);
                }
                
                if (typeof note.title !== 'string') {
                    note.title = 'æœªå‘½åç¬”è®°';
                    repairReport.totalIssues++;
                    repairReport.repairedIssues++;
                    repairReport.details.push(`ä¿®å¤ç¬”è®°æ ‡é¢˜: ${noteId}`);
                }
            });
            
            log(`æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å®Œæˆï¼Œä¿®å¤äº† ${repairReport.repairedIssues} ä¸ªé—®é¢˜`);
            return repairReport;
        }

        // æ¨¡æ‹Ÿæ•°æ®æ¢å¤å‡½æ•°
        async function mockRecoverData() {
            log('æ¨¡æ‹Ÿæ•°æ®æ¢å¤æµç¨‹...');
            
            // 1. å°è¯•ä»IndexedDBæ¢å¤
            if (mockIndexedDBStorage.isAvailable) {
                try {
                    const data = await mockIndexedDBStorage.loadData();
                    if (data && data.notes && Object.keys(data.notes).length > 0) {
                        log('ä»IndexedDBæ¢å¤æ•°æ®æˆåŠŸ');
                        return data;
                    }
                } catch (error) {
                    log('ä»IndexedDBæ¢å¤å¤±è´¥: ' + error.message);
                }
            }
            
            // 2. å°è¯•ä»å¤‡ä»½æ¢å¤
            const backups = await mockIndexedDBStorage.getAllBackups();
            if (backups.length > 0) {
                backups.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const latestBackup = backups[0];
                log('ä»å¤‡ä»½æ¢å¤æ•°æ®æˆåŠŸ: ' + latestBackup.timestamp);
                return latestBackup.data;
            }
            
            log('æ‰€æœ‰æ•°æ®æ¢å¤æ–¹æ¡ˆéƒ½å¤±è´¥');
            return null;
        }

        async function startTest() {
            testStep = 0;
            clearLog();
            log('å¼€å§‹é˜¶æ®µå››ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•...');
            
            try {
                // æ­¥éª¤1: åˆå§‹åŒ–IndexedDBå­˜å‚¨æ¨¡å—
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: åˆå§‹åŒ–IndexedDBå­˜å‚¨æ¨¡å—`);
                
                window.indexedDBStorage = mockIndexedDBStorage;
                log('IndexedDBå­˜å‚¨æ¨¡å—åˆå§‹åŒ–æˆåŠŸ');
                updateStepStatus(testStep - 1, 'success', 'IndexedDBæ¨¡å—åˆå§‹åŒ–æˆåŠŸ');

                // æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®`);
                
                const testData = {
                    currentNoteId: 'test-note-1',
                    notes: {
                        'test-note-1': {
                            id: 'test-note-1',
                            title: 'æµ‹è¯•ç¬”è®°',
                            content: '# æµ‹è¯•å†…å®¹\n\nè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç¬”è®°ã€‚',
                            lastModified: new Date().toISOString(),
                            versions: []
                        },
                        'test-note-2': {
                            id: 'test-note-2',
                            title: 'å¦ä¸€ä¸ªæµ‹è¯•ç¬”è®°',
                            content: 'è¿™æ˜¯å¦ä¸€ä¸ªæµ‹è¯•ç¬”è®°çš„å†…å®¹ã€‚',
                            lastModified: new Date().toISOString(),
                            versions: []
                        }
                    }
                };
                
                await mockIndexedDBStorage.saveData(testData);
                await mockIndexedDBStorage.backupData(testData);
                log('æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆï¼ŒåŒ…å«2ä¸ªç¬”è®°å’Œ1ä¸ªå¤‡ä»½');
                updateStepStatus(testStep - 1, 'success', 'æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ');

                // æ­¥éª¤3: æµ‹è¯•æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: æµ‹è¯•æ•°æ®å®Œæ•´æ€§æ£€æŸ¥`);
                
                const repairReport = mockCheckAndRepairData(testData);
                if (repairReport.repairedIssues === 0) {
                    log('âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼šæ²¡æœ‰å‘ç°é—®é¢˜');
                    updateStepStatus(testStep - 1, 'success', 'æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡');
                } else {
                    log(`âœ… æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡ï¼šä¿®å¤äº† ${repairReport.repairedIssues} ä¸ªé—®é¢˜`);
                    updateStepStatus(testStep - 1, 'success', `ä¿®å¤äº† ${repairReport.repairedIssues} ä¸ªé—®é¢˜`);
                }

                // æ­¥éª¤4: æµ‹è¯•æ•°æ®æŸåæ£€æµ‹
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: æµ‹è¯•æ•°æ®æŸåæ£€æµ‹`);
                
                // æ¨¡æ‹Ÿæ•°æ®æŸå
                testData.notes['corrupted-note'] = {
                    id: 'corrupted-note',
                    title: null, // æŸåçš„æ ‡é¢˜
                    content: undefined, // æŸåçš„å†…å®¹
                    lastModified: new Date().toISOString(),
                    versions: 'invalid' // æŸåçš„ç‰ˆæœ¬æ•°ç»„
                };
                
                const corruptionReport = mockCheckAndRepairData(testData);
                if (corruptionReport.repairedIssues > 0) {
                    log('âœ… æ•°æ®æŸåæ£€æµ‹é€šè¿‡ï¼šæˆåŠŸæ£€æµ‹å¹¶ä¿®å¤æŸåæ•°æ®');
                    updateStepStatus(testStep - 1, 'success', 'æ•°æ®æŸåæ£€æµ‹é€šè¿‡');
                } else {
                    throw new Error('æ•°æ®æŸåæ£€æµ‹å¤±è´¥ï¼šæ²¡æœ‰æ£€æµ‹åˆ°æŸåæ•°æ®');
                }

                // æ­¥éª¤5: æµ‹è¯•æ•°æ®æ¢å¤æœºåˆ¶
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: æµ‹è¯•æ•°æ®æ¢å¤æœºåˆ¶`);
                
                const recoveredData = await mockRecoverData();
                if (recoveredData && recoveredData.notes) {
                    log('âœ… æ•°æ®æ¢å¤æœºåˆ¶æµ‹è¯•é€šè¿‡ï¼šæˆåŠŸæ¢å¤æ•°æ®');
                    updateStepStatus(testStep - 1, 'success', 'æ•°æ®æ¢å¤æœºåˆ¶æµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('æ•°æ®æ¢å¤æœºåˆ¶æµ‹è¯•å¤±è´¥ï¼šæ— æ³•æ¢å¤æ•°æ®');
                }

                // æ­¥éª¤6: æµ‹è¯•ç´§æ€¥æ¢å¤æµç¨‹
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: æµ‹è¯•ç´§æ€¥æ¢å¤æµç¨‹`);
                
                // æ¨¡æ‹ŸIndexedDBä¸å¯ç”¨
                mockIndexedDBStorage.isAvailable = false;
                
                try {
                    const emergencyData = await mockRecoverData();
                    if (emergencyData) {
                        log('âœ… ç´§æ€¥æ¢å¤æµç¨‹æµ‹è¯•é€šè¿‡ï¼šä»å¤‡ä»½æ¢å¤æ•°æ®');
                        updateStepStatus(testStep - 1, 'success', 'ç´§æ€¥æ¢å¤æµç¨‹æµ‹è¯•é€šè¿‡');
                    } else {
                        throw new Error('ç´§æ€¥æ¢å¤å¤±è´¥');
                    }
                } finally {
                    mockIndexedDBStorage.isAvailable = true;
                }

                // æ­¥éª¤7: æµ‹è¯•æ•°æ®å¥åº·ç›‘æ§
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: æµ‹è¯•æ•°æ®å¥åº·ç›‘æ§`);
                
                const healthReport = {
                    timestamp: new Date().toISOString(),
                    totalNotes: Object.keys(testData.notes).length,
                    totalVersions: 0,
                    dataSize: JSON.stringify(testData).length,
                    issues: []
                };
                
                if (healthReport.totalNotes > 0) {
                    log('âœ… æ•°æ®å¥åº·ç›‘æ§æµ‹è¯•é€šè¿‡ï¼šæ•°æ®çŠ¶æ€æ­£å¸¸');
                    updateStepStatus(testStep - 1, 'success', 'æ•°æ®å¥åº·ç›‘æ§æµ‹è¯•é€šè¿‡');
                } else {
                    throw new Error('æ•°æ®å¥åº·ç›‘æ§æµ‹è¯•å¤±è´¥ï¼šæ•°æ®çŠ¶æ€å¼‚å¸¸');
                }

                // æ­¥éª¤8: éªŒè¯é”™è¯¯å¤„ç†å®Œå–„æ€§
                testStep++;
                updateProgress(testStep);
                log(`æ­¥éª¤${testStep}: éªŒè¯é”™è¯¯å¤„ç†å®Œå–„æ€§`);
                
                // æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µ
                let errorHandlingScore = 0;
                
                // æµ‹è¯•IndexedDBä¸å¯ç”¨
                mockIndexedDBStorage.isAvailable = false;
                try {
                    await mockIndexedDBStorage.loadData();
                } catch (error) {
                    errorHandlingScore++;
                    log('âœ… IndexedDBä¸å¯ç”¨é”™è¯¯å¤„ç†æ­£å¸¸');
                }
                
                // æµ‹è¯•æ•°æ®æ¢å¤
                const recoveryResult = await mockRecoverData();
                if (recoveryResult) {
                    errorHandlingScore++;
                    log('âœ… æ•°æ®æ¢å¤é”™è¯¯å¤„ç†æ­£å¸¸');
                }
                
                mockIndexedDBStorage.isAvailable = true;
                
                if (errorHandlingScore >= 2) {
                    log('âœ… é”™è¯¯å¤„ç†å®Œå–„æ€§éªŒè¯é€šè¿‡');
                    updateStepStatus(testStep - 1, 'success', 'é”™è¯¯å¤„ç†å®Œå–„æ€§éªŒè¯é€šè¿‡');
                } else {
                    throw new Error('é”™è¯¯å¤„ç†å®Œå–„æ€§éªŒè¯å¤±è´¥');
                }

                // æµ‹è¯•å®Œæˆ
                log('ğŸ‰ é˜¶æ®µå››ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼');
                
                // æ›´æ–°å¥åº·æŠ¥å‘Š
                updateHealthReport({
                    'æ•°æ®å®Œæ•´æ€§': { status: 'good', text: 'æ­£å¸¸' },
                    'å¤‡ä»½çŠ¶æ€': { status: 'good', text: 'å¯ç”¨' },
                    'é”™è¯¯å¤„ç†': { status: 'good', text: 'æ­£å¸¸' },
                    'æ¢å¤æœºåˆ¶': { status: 'good', text: 'æ­£å¸¸' }
                });
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStepStatus(testStep - 1, 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
                
                updateHealthReport({
                    'æ•°æ®å®Œæ•´æ€§': { status: 'error', text: 'å¼‚å¸¸' },
                    'å¤‡ä»½çŠ¶æ€': { status: 'warning', text: 'æ£€æŸ¥ä¸­' },
                    'é”™è¯¯å¤„ç†': { status: 'error', text: 'å¼‚å¸¸' },
                    'æ¢å¤æœºåˆ¶': { status: 'warning', text: 'æ£€æŸ¥ä¸­' }
                });
            }
        }

        function testDataCorruption() {
            log('å¼€å§‹æµ‹è¯•æ•°æ®æŸååœºæ™¯...');
            
            // æ¨¡æ‹Ÿæ•°æ®æŸå
            const corruptedData = {
                currentNoteId: 'corrupted-note',
                notes: {
                    'corrupted-note': {
                        id: 'corrupted-note',
                        title: null,
                        content: undefined,
                        lastModified: 'invalid-date',
                        versions: 'not-an-array'
                    },
                    'normal-note': {
                        id: 'normal-note',
                        title: 'æ­£å¸¸ç¬”è®°',
                        content: 'è¿™æ˜¯æ­£å¸¸çš„å†…å®¹',
                        lastModified: new Date().toISOString(),
                        versions: []
                    }
                }
            };
            
            log('åˆ›å»ºæŸåçš„æµ‹è¯•æ•°æ®...');
            const repairReport = mockCheckAndRepairData(corruptedData);
            
            log(`æ•°æ®æŸåæµ‹è¯•å®Œæˆï¼Œä¿®å¤äº† ${repairReport.repairedIssues} ä¸ªé—®é¢˜`);
            log('ä¿®å¤è¯¦æƒ…:', repairReport.details);
        }

        async function testDataRecovery() {
            log('å¼€å§‹æµ‹è¯•æ•°æ®æ¢å¤åœºæ™¯...');
            
            // æ¨¡æ‹ŸIndexedDBä¸å¯ç”¨
            mockIndexedDBStorage.isAvailable = false;
            
            try {
                const recoveredData = await mockRecoverData();
                if (recoveredData) {
                    log('âœ… æ•°æ®æ¢å¤æµ‹è¯•æˆåŠŸï¼šä»å¤‡ä»½æ¢å¤æ•°æ®');
                    log(`æ¢å¤çš„ç¬”è®°æ•°é‡: ${Object.keys(recoveredData.notes).length}`);
                } else {
                    log('âŒ æ•°æ®æ¢å¤æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰å¯ç”¨çš„å¤‡ä»½æ•°æ®');
                }
            } finally {
                mockIndexedDBStorage.isAvailable = true;
            }
        }

        function loadMainApp() {
            log('åŠ è½½ä¸»åº”ç”¨è¿›è¡Œé›†æˆæµ‹è¯•...');
            const iframe = document.createElement('iframe');
            iframe.src = 'index.html';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '10px';
            iframe.style.marginTop = '20px';
            
            const container = document.querySelector('.container');
            container.appendChild(iframe);
            
            log('ä¸»åº”ç”¨åŠ è½½å®Œæˆï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨é”™è¯¯å¤„ç†æµ‹è¯•');
        }

        window.addEventListener('load', () => {
            log('é˜¶æ®µå››ï¼šé”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
        });
    </script>
</body>
</html>
