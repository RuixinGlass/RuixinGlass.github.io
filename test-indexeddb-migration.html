<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB迁移修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 IndexedDB迁移修复测试</h1>
    
    <div class="test-section">
        <h2>📋 测试概述</h2>
        <p>本测试页面用于验证IndexedDB迁移修复是否正常工作，包括：</p>
        <ul>
            <li>✅ 异步数据加载测试</li>
            <li>✅ 数据保存测试</li>
            <li>✅ 错误处理测试</li>
            <li>✅ 回退机制测试</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🧪 测试控制</h2>
        <button onclick="runAllTests()">运行所有测试</button>
        <button onclick="clearLog()">清空日志</button>
        <button onclick="clearStorage()">清空存储</button>
        <button onclick="loadTestData()">加载测试数据</button>
    </div>

    <div class="test-section">
        <h2>📊 测试结果</h2>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>📝 详细日志</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        let testResults = [];
        let logMessages = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('log');
            logElement.innerHTML = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function addTestResult(testName, success, message) {
            const result = { testName, success, message, timestamp: new Date() };
            testResults.push(result);
            
            const resultsElement = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'success' : 'error'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${success ? '✅ 通过' : '❌ 失败'}
                <br><small>${message}</small>
            `;
            resultsElement.appendChild(resultDiv);
        }

        function clearLog() {
            logMessages = [];
            document.getElementById('log').innerHTML = '';
            document.getElementById('testResults').innerHTML = '';
            testResults = [];
        }

        function clearStorage() {
            try {
                localStorage.clear();
                if (window.indexedDBStorage) {
                    window.indexedDBStorage.deleteDatabase().then(() => {
                        log('存储已清空', 'success');
                    });
                } else {
                    log('存储已清空（仅localStorage）', 'warning');
                }
            } catch (error) {
                log(`清空存储失败: ${error.message}`, 'error');
            }
        }

        async function loadTestData() {
            const testData = {
                currentNoteId: 'test_note_1',
                notes: {
                    'test_note_1': {
                        title: '测试笔记1',
                        content: '# 测试笔记\n\n这是一个测试笔记的内容。',
                        versions: [],
                        lastModified: new Date().toISOString()
                    },
                    'test_note_2': {
                        title: '测试笔记2',
                        content: '## 第二个测试笔记\n\n更多测试内容。',
                        versions: [],
                        lastModified: new Date().toISOString()
                    }
                }
            };

            try {
                if (window.indexedDBStorage) {
                    await window.indexedDBStorage.saveData(testData);
                    log('测试数据已加载到IndexedDB', 'success');
                } else {
                    localStorage.setItem('notesData', JSON.stringify(testData));
                    log('测试数据已加载到localStorage', 'warning');
                }
            } catch (error) {
                log(`加载测试数据失败: ${error.message}`, 'error');
            }
        }

        // 测试1: IndexedDB存储模块加载测试
        async function testIndexedDBModuleLoading() {
            log('开始测试: IndexedDB存储模块加载');
            
            try {
                // 动态加载IndexedDB存储模块
                const script = document.createElement('script');
                script.src = 'indexeddb-storage.js';
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
                
                if (window.indexedDBStorage) {
                    addTestResult('IndexedDB模块加载', true, '模块加载成功');
                    log('IndexedDB存储模块加载成功', 'success');
                } else {
                    addTestResult('IndexedDB模块加载', false, '模块未正确初始化');
                    log('IndexedDB存储模块未正确初始化', 'error');
                }
            } catch (error) {
                addTestResult('IndexedDB模块加载', false, `加载失败: ${error.message}`);
                log(`IndexedDB模块加载失败: ${error.message}`, 'error');
            }
        }

        // 测试2: 数据保存测试
        async function testDataSaving() {
            log('开始测试: 数据保存功能');
            
            if (!window.indexedDBStorage) {
                addTestResult('数据保存', false, 'IndexedDB模块未加载');
                return;
            }

            const testData = {
                currentNoteId: 'test_save',
                notes: {
                    'test_save': {
                        title: '保存测试',
                        content: '测试保存功能',
                        versions: [],
                        lastModified: new Date().toISOString()
                    }
                }
            };

            try {
                await window.indexedDBStorage.saveData(testData);
                addTestResult('数据保存', true, '数据保存成功');
                log('数据保存测试通过', 'success');
            } catch (error) {
                addTestResult('数据保存', false, `保存失败: ${error.message}`);
                log(`数据保存失败: ${error.message}`, 'error');
            }
        }

        // 测试3: 数据加载测试
        async function testDataLoading() {
            log('开始测试: 数据加载功能');
            
            if (!window.indexedDBStorage) {
                addTestResult('数据加载', false, 'IndexedDB模块未加载');
                return;
            }

            try {
                const data = await window.indexedDBStorage.loadData();
                if (data && data.notes) {
                    addTestResult('数据加载', true, `成功加载 ${Object.keys(data.notes).length} 个笔记`);
                    log(`数据加载成功，笔记数量: ${Object.keys(data.notes).length}`, 'success');
                } else {
                    addTestResult('数据加载', true, '加载成功（无数据）');
                    log('数据加载成功（无数据）', 'info');
                }
            } catch (error) {
                addTestResult('数据加载', false, `加载失败: ${error.message}`);
                log(`数据加载失败: ${error.message}`, 'error');
            }
        }

        // 测试4: 错误处理测试
        async function testErrorHandling() {
            log('开始测试: 错误处理机制');
            
            // 测试localStorage回退
            const testData = {
                currentNoteId: 'error_test',
                notes: {
                    'error_test': {
                        title: '错误处理测试',
                        content: '测试错误处理',
                        versions: [],
                        lastModified: new Date().toISOString()
                    }
                }
            };

            // 保存到localStorage作为回退
            localStorage.setItem('notesData', JSON.stringify(testData));
            
            try {
                // 模拟IndexedDB失败的情况
                const originalLoadData = window.indexedDBStorage?.loadData;
                if (window.indexedDBStorage) {
                    window.indexedDBStorage.loadData = () => {
                        throw new Error('模拟IndexedDB失败');
                    };
                }

                // 这里应该会回退到localStorage
                const data = JSON.parse(localStorage.getItem('notesData') || '{}');
                if (data.notes && Object.keys(data.notes).length > 0) {
                    addTestResult('错误处理', true, '回退机制正常工作');
                    log('错误处理测试通过，回退机制正常', 'success');
                } else {
                    addTestResult('错误处理', false, '回退机制未正常工作');
                    log('错误处理测试失败，回退机制异常', 'error');
                }

                // 恢复原始方法
                if (window.indexedDBStorage && originalLoadData) {
                    window.indexedDBStorage.loadData = originalLoadData;
                }
            } catch (error) {
                addTestResult('错误处理', false, `错误处理测试失败: ${error.message}`);
                log(`错误处理测试失败: ${error.message}`, 'error');
            }
        }

        // 测试5: 异步操作测试
        async function testAsyncOperations() {
            log('开始测试: 异步操作');
            
            const startTime = Date.now();
            
            try {
                // 测试多个异步操作
                const promises = [];
                for (let i = 0; i < 5; i++) {
                    const testData = {
                        currentNoteId: `async_test_${i}`,
                        notes: {
                            [`async_test_${i}`]: {
                                title: `异步测试${i}`,
                                content: `异步测试内容${i}`,
                                versions: [],
                                lastModified: new Date().toISOString()
                            }
                        }
                    };
                    
                    if (window.indexedDBStorage) {
                        promises.push(window.indexedDBStorage.saveData(testData));
                    }
                }
                
                if (promises.length > 0) {
                    await Promise.all(promises);
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    addTestResult('异步操作', true, `并发操作完成，耗时: ${duration}ms`);
                    log(`异步操作测试通过，耗时: ${duration}ms`, 'success');
                } else {
                    addTestResult('异步操作', false, 'IndexedDB模块未加载');
                    log('异步操作测试跳过，IndexedDB模块未加载', 'warning');
                }
            } catch (error) {
                addTestResult('异步操作', false, `异步操作失败: ${error.message}`);
                log(`异步操作失败: ${error.message}`, 'error');
            }
        }

        // 运行所有测试
        async function runAllTests() {
            clearLog();
            log('开始运行所有测试...', 'info');
            
            await testIndexedDBModuleLoading();
            await testDataSaving();
            await testDataLoading();
            await testErrorHandling();
            await testAsyncOperations();
            
            log('所有测试完成', 'info');
            
            // 统计结果
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            log(`测试总结: ${passedTests}/${totalTests} 通过，${failedTests} 失败`, 
                failedTests === 0 ? 'success' : 'error');
        }

        // 页面加载时自动运行基础测试
        window.addEventListener('load', () => {
            log('测试页面已加载', 'info');
            log('请点击"运行所有测试"按钮开始测试', 'info');
        });
    </script>
</body>
</html>

