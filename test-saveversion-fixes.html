<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>saveVersion()ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .test-button.danger:hover {
            background: #c82333;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ saveVersion()ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•saveVersion()å‡½æ•°è°ƒç”¨çš„å¼‚æ­¥å¤„ç†ä¿®å¤ï¼š</p>
        <ul>
            <li><strong>å…³é”®æ“ä½œ</strong>ï¼šä½¿ç”¨awaitç¡®ä¿å®Œæˆï¼ˆé€€å‡ºç¼–è¾‘æ¨¡å¼ï¼‰</li>
            <li><strong>éå…³é”®æ“ä½œ</strong>ï¼šä½¿ç”¨.catch()é¿å…é˜»å¡UIï¼ˆåˆ‡æ¢ç¬”è®°ã€å¿«æ·é”®ã€æ€§èƒ½ä¼˜åŒ–æ¨¡å—ï¼‰</li>
        </ul>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <div id="testSteps">
            <div class="status info">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>
        </div>
        
        <button class="test-button" onclick="startTest()">å¼€å§‹æµ‹è¯•</button>
        <button class="test-button danger" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <button class="test-button" onclick="loadMainApp()">åŠ è½½ä¸»åº”ç”¨</button>
    </div>

    <div class="test-container">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="logArea" class="log-area"></div>
    </div>

    <script>
        let testStep = 0;
        const testSteps = [
            "1. åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—",
            "2. åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®",
            "3. æµ‹è¯•åˆ‡æ¢ç¬”è®°æ—¶çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰",
            "4. æµ‹è¯•å¿«æ·é”®ä¿å­˜çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰",
            "5. æµ‹è¯•æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰",
            "6. æµ‹è¯•é€€å‡ºç¼–è¾‘æ¨¡å¼çš„saveVersion()è°ƒç”¨ï¼ˆé˜»å¡ï¼‰",
            "7. éªŒè¯æ•°æ®ä¿å­˜ç»“æœ"
        ];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStepStatus(step, status, message) {
            const testStepsDiv = document.getElementById('testSteps');
            const statusClass = status === 'success' ? 'success' : status === 'error' ? 'error' : 'info';
            testStepsDiv.innerHTML += `<div class="status ${statusClass}">${testSteps[step]}: ${message}</div>`;
        }

        function clearLog() {
            document.getElementById('logArea').textContent = '';
            document.getElementById('testSteps').innerHTML = '<div class="status info">å‡†å¤‡å¼€å§‹æµ‹è¯•...</div>';
            testStep = 0;
        }

        async function startTest() {
            clearLog();
            log('å¼€å§‹saveVersion()ä¿®å¤æµ‹è¯•...');
            
            try {
                // æ­¥éª¤1: åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—
                log('æ­¥éª¤1: åŠ è½½IndexedDBå­˜å‚¨æ¨¡å—');
                await loadIndexedDBModule();
                updateStepStatus(0, 'success', 'æ¨¡å—åŠ è½½æˆåŠŸ');
                
                // æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®
                log('æ­¥éª¤2: åˆ›å»ºæµ‹è¯•ç¬”è®°æ•°æ®');
                await createTestData();
                updateStepStatus(1, 'success', 'æµ‹è¯•æ•°æ®åˆ›å»ºæˆåŠŸ');
                
                // æ­¥éª¤3: æµ‹è¯•åˆ‡æ¢ç¬”è®°æ—¶çš„saveVersion()è°ƒç”¨
                log('æ­¥éª¤3: æµ‹è¯•åˆ‡æ¢ç¬”è®°æ—¶çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰');
                await testSwitchNoteSaveVersion();
                updateStepStatus(2, 'success', 'åˆ‡æ¢ç¬”è®°ä¿å­˜æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤4: æµ‹è¯•å¿«æ·é”®ä¿å­˜
                log('æ­¥éª¤4: æµ‹è¯•å¿«æ·é”®ä¿å­˜çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰');
                await testShortcutSaveVersion();
                updateStepStatus(3, 'success', 'å¿«æ·é”®ä¿å­˜æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤5: æµ‹è¯•æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­çš„ä¿å­˜
                log('æ­¥éª¤5: æµ‹è¯•æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­çš„saveVersion()è°ƒç”¨ï¼ˆéé˜»å¡ï¼‰');
                await testPerformanceOptimizerSaveVersion();
                updateStepStatus(4, 'success', 'æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¿å­˜æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤6: æµ‹è¯•é€€å‡ºç¼–è¾‘æ¨¡å¼çš„ä¿å­˜
                log('æ­¥éª¤6: æµ‹è¯•é€€å‡ºç¼–è¾‘æ¨¡å¼çš„saveVersion()è°ƒç”¨ï¼ˆé˜»å¡ï¼‰');
                await testExitEditModeSaveVersion();
                updateStepStatus(5, 'success', 'é€€å‡ºç¼–è¾‘æ¨¡å¼ä¿å­˜æµ‹è¯•é€šè¿‡');
                
                // æ­¥éª¤7: éªŒè¯æ•°æ®ä¿å­˜ç»“æœ
                log('æ­¥éª¤7: éªŒè¯æ•°æ®ä¿å­˜ç»“æœ');
                await verifySaveResults();
                updateStepStatus(6, 'success', 'æ•°æ®ä¿å­˜éªŒè¯é€šè¿‡');
                
                log('âœ… æ‰€æœ‰saveVersion()ä¿®å¤æµ‹è¯•é€šè¿‡ï¼');
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStepStatus(testStep, 'error', `æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        async function loadIndexedDBModule() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'indexeddb-storage.js';
                script.onload = () => {
                    log('IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½æˆåŠŸ');
                    resolve();
                };
                script.onerror = () => reject(new Error('IndexedDBå­˜å‚¨æ¨¡å—åŠ è½½å¤±è´¥'));
                document.head.appendChild(script);
            });
        }

        async function createTestData() {
            // æ¨¡æ‹ŸnotesDataå¯¹è±¡
            window.notesData = {
                currentNoteId: 'test-note-1',
                notes: {
                    'test-note-1': {
                        title: 'æµ‹è¯•ç¬”è®°1',
                        content: 'è¿™æ˜¯æµ‹è¯•ç¬”è®°1çš„å†…å®¹',
                        lastModified: new Date().toISOString(),
                        versions: []
                    },
                    'test-note-2': {
                        title: 'æµ‹è¯•ç¬”è®°2',
                        content: 'è¿™æ˜¯æµ‹è¯•ç¬”è®°2çš„å†…å®¹',
                        lastModified: new Date().toISOString(),
                        versions: []
                    }
                }
            };
            
            // æ¨¡æ‹ŸsaveToLocalStorageå‡½æ•°
            window.saveToLocalStorage = async function() {
                log('æ¨¡æ‹ŸsaveToLocalStorageè¢«è°ƒç”¨');
                await new Promise(resolve => setTimeout(resolve, 100)); // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
                log('æ¨¡æ‹ŸsaveToLocalStorageå®Œæˆ');
                return Promise.resolve();
            };
            
            // æ¨¡æ‹ŸsaveVersionå‡½æ•°
            window.saveVersion = async function() {
                log('saveVersionå‡½æ•°è¢«è°ƒç”¨');
                if (!window.notesData.currentNoteId) return;
                
                const note = window.notesData.notes[window.notesData.currentNoteId];
                note.content += '\n[å·²ä¿å­˜]';
                note.lastModified = new Date().toISOString();
                
                try {
                    await window.saveToLocalStorage();
                    log('saveVersionå†…éƒ¨ä¿å­˜æˆåŠŸ');
                } catch (error) {
                    log(`saveVersionå†…éƒ¨ä¿å­˜å¤±è´¥: ${error.message}`);
                    throw error;
                }
            };
            
            log('æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ');
        }

        async function testSwitchNoteSaveVersion() {
            log('æ¨¡æ‹Ÿåˆ‡æ¢ç¬”è®°æ—¶çš„saveVersion()è°ƒç”¨');
            
            // æ¨¡æ‹Ÿåˆ‡æ¢ç¬”è®°çš„é€»è¾‘
            const originalNoteId = window.notesData.currentNoteId;
            window.notesData.currentNoteId = 'test-note-2';
            
            // è¿™é‡Œåº”è¯¥è°ƒç”¨éé˜»å¡çš„saveVersion()
            window.saveVersion().catch(error => {
                log(`åˆ‡æ¢ç¬”è®°æ—¶è‡ªåŠ¨ä¿å­˜å¤±è´¥: ${error.message}`);
            });
            
            log('åˆ‡æ¢ç¬”è®°ä¿å­˜è°ƒç”¨å®Œæˆï¼ˆéé˜»å¡ï¼‰');
            await new Promise(resolve => setTimeout(resolve, 200)); // ç­‰å¾…å¼‚æ­¥æ“ä½œ
        }

        async function testShortcutSaveVersion() {
            log('æ¨¡æ‹Ÿå¿«æ·é”®ä¿å­˜çš„saveVersion()è°ƒç”¨');
            
            // æ¨¡æ‹ŸCtrl+Så¿«æ·é”®
            if (window.notesData.currentNoteId) {
                window.saveVersion().catch(error => {
                    log(`å¿«æ·é”®ä¿å­˜å¤±è´¥: ${error.message}`);
                });
            }
            
            log('å¿«æ·é”®ä¿å­˜è°ƒç”¨å®Œæˆï¼ˆéé˜»å¡ï¼‰');
            await new Promise(resolve => setTimeout(resolve, 200)); // ç­‰å¾…å¼‚æ­¥æ“ä½œ
        }

        async function testPerformanceOptimizerSaveVersion() {
            log('æ¨¡æ‹Ÿæ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­çš„saveVersion()è°ƒç”¨');
            
            // æ¨¡æ‹Ÿæ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­çš„åˆ‡æ¢ç¬”è®°é€»è¾‘
            const contentArea = { classList: { contains: () => true } };
            if (contentArea && contentArea.classList.contains('editing-mode')) {
                window.saveVersion().catch(error => {
                    log(`æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¸­åˆ‡æ¢ç¬”è®°æ—¶è‡ªåŠ¨ä¿å­˜å¤±è´¥: ${error.message}`);
                });
            }
            
            log('æ€§èƒ½ä¼˜åŒ–æ¨¡å—ä¿å­˜è°ƒç”¨å®Œæˆï¼ˆéé˜»å¡ï¼‰');
            await new Promise(resolve => setTimeout(resolve, 200)); // ç­‰å¾…å¼‚æ­¥æ“ä½œ
        }

        async function testExitEditModeSaveVersion() {
            log('æ¨¡æ‹Ÿé€€å‡ºç¼–è¾‘æ¨¡å¼çš„saveVersion()è°ƒç”¨ï¼ˆé˜»å¡ï¼‰');
            
            // æ¨¡æ‹Ÿé€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨await
            try {
                await window.saveVersion();
                log('é€€å‡ºç¼–è¾‘æ¨¡å¼ä¿å­˜æˆåŠŸï¼ˆé˜»å¡ï¼‰');
            } catch (error) {
                log(`é€€å‡ºç¼–è¾‘æ¨¡å¼ä¿å­˜å¤±è´¥: ${error.message}`);
                throw error;
            }
        }

        async function verifySaveResults() {
            log('éªŒè¯æ•°æ®ä¿å­˜ç»“æœ...');
            
            // æ£€æŸ¥ç¬”è®°å†…å®¹æ˜¯å¦è¢«æ›´æ–°
            const note1 = window.notesData.notes['test-note-1'];
            const note2 = window.notesData.notes['test-note-2'];
            
            if (note1.content.includes('[å·²ä¿å­˜]') || note2.content.includes('[å·²ä¿å­˜]')) {
                log('âœ… æ•°æ®ä¿å­˜éªŒè¯é€šè¿‡ï¼šç¬”è®°å†…å®¹å·²æ›´æ–°');
            } else {
                log('âŒ æ•°æ®ä¿å­˜éªŒè¯å¤±è´¥ï¼šç¬”è®°å†…å®¹æœªæ›´æ–°');
                throw new Error('æ•°æ®ä¿å­˜éªŒè¯å¤±è´¥');
            }
        }

        function loadMainApp() {
            log('åŠ è½½ä¸»åº”ç”¨è¿›è¡Œé›†æˆæµ‹è¯•...');
            const iframe = document.createElement('iframe');
            iframe.src = 'index.html';
            iframe.style.width = '100%';
            iframe.style.height = '600px';
            iframe.style.border = '1px solid #ccc';
            
            const container = document.createElement('div');
            container.className = 'test-container';
            container.innerHTML = '<h2>ä¸»åº”ç”¨é›†æˆæµ‹è¯•</h2>';
            container.appendChild(iframe);
            
            document.body.appendChild(container);
            
            iframe.onload = () => {
                log('ä¸»åº”ç”¨åŠ è½½å®Œæˆï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
                log('æµ‹è¯•å»ºè®®ï¼š');
                log('1. åˆ›å»ºæ–°ç¬”è®°');
                log('2. ç¼–è¾‘ç¬”è®°å†…å®¹');
                log('3. ä½¿ç”¨Ctrl+Sä¿å­˜');
                log('4. åˆ‡æ¢ç¬”è®°');
                log('5. é€€å‡ºç¼–è¾‘æ¨¡å¼');
                log('6. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
            };
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('saveVersion()ä¿®å¤æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ç‚¹å‡»"å¼€å§‹æµ‹è¯•"æŒ‰é’®å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•');
        });
    </script>
</body>
</html>
