# 云同步大文件拉取修复知识点

---

## 背景

在“严谨的版本控制笔记系统”项目中，使用 GitHub Gist 作为云端存储，支持笔记数据的上传与拉取。当单个笔记数据文件（如 notes-data.json）较大（如 200k 以上）时，出现“可以上传但无法拉取”的问题，报错为：

> 拉取失败：Failed to fetch

---

## 问题原因

1. **GitHub Gist API 的 truncated 字段**
   - 当 Gist 文件较大时，API 返回的 `files['notes-data.json'].content` 只包含部分内容，并设置 `truncated: true`。
   - 此时还会返回 `raw_url` 字段，指向完整文件内容。

2. **拉取 raw_url 时的 CORS/权限问题**
   - 直接用 fetch 拉取 raw_url，如果加了 Authorization header，会被 CORS 拒绝或返回 404。
   - 正确做法是**不加 token header**，直接 fetch raw_url。

---

## 修复方案

### 1. 检查 truncated 字段
- 拉取 Gist 后，判断 `file.truncated` 是否为 true。
- 如果是 true，需用 `file.raw_url` 再 fetch 一次，获取完整内容。

### 2. 拉取 raw_url 时不加 Authorization header
- 只在 API 拉取 gist 时加 token，拉 raw_url 时不要加 token header。

### 3. 修正后的 fetchFromGist 代码示例
```js
async function fetchFromGist(token, gistId) {
    if (!gistId) throw new Error('请填写 Gist ID');
    const url = `https://api.github.com/gists/${gistId}`;
    const res = await fetch(url, {
        headers: {
            'Authorization': 'token ' + token,
            'Accept': 'application/vnd.github+json'
        }
    });
    if (!res.ok) throw new Error('拉取失败: ' + res.status);
    const result = await res.json();
    const file = result.files['notes-data.json'];
    if (!file) throw new Error('云端未找到 notes-data.json 文件');
    let content = file.content;
    if (file.truncated && file.raw_url) {
        // 重新 fetch 全量内容，不加 token
        const rawRes = await fetch(file.raw_url);
        if (!rawRes.ok) throw new Error('拉取大文件失败: ' + rawRes.status);
        content = await rawRes.text();
    }
    return JSON.parse(content);
}
```

---

## 其它相关知识点

- **Gist 单文件大小建议**：官方建议小于 1MB，过大时建议分片或只同步部分数据。
- **云同步常见问题**：API 限制、CORS、token 权限、数据一致性、性能等。
- **调试建议**：遇到拉取失败时，优先查看浏览器 Network/Console 面板，关注 HTTP 状态码和 CORS 报错。

---

## 总结

- 云同步大文件拉取失败，常因 Gist API 返回 truncated，需用 raw_url 再 fetch 全量内容。
- 拉 raw_url 时不能加 token header，否则会被 CORS 拒绝。
- 修正后可支持大体积笔记数据的完整同步。

---

如需更多云同步、API 调试、前端性能优化等知识点，欢迎随时补充！ 